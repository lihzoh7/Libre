<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>***SLIDE***</title>
  <style>
    :root{--game-width:100%;--game-height:500px}
    body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#111;font-family:Inter,system-ui,Arial;color:#fff}
    .game-wrap{width:800px;max-width:96vw;height:var(--game-height);position:relative;overflow:hidden;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.7)}
    .bg{position:absolute;inset:0;background-image:url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=1600&q=80');background-size:cover;background-repeat:repeat-x;transform:translateZ(0)}
    .player{position:absolute;left:120px;width:48px;height:72px;font-size:40px;display:flex;align-items:center;justify-content:center;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.6);z-index:30;transition:transform .08s linear}
    .ring{position:absolute;width:84px;height:84px;border-radius:50%;box-sizing:border-box;pointer-events:none;display:flex;align-items:center;justify-content:center;z-index:10}
    .ring.visual{border:6px solid rgba(255,215,0,.95);filter:drop-shadow(0 8px 18px rgba(255,200,60,.15));transform:rotateX(80deg);}
    .fruit{position:absolute;font-size:32px;animation:float 2s ease-in-out infinite alternate;z-index:12}
    @keyframes float{from{transform:translateY(-5px)}to{transform:translateY(5px)}}
    .hud{position:absolute;left:12px;top:12px;z-index:50}
    .title{font-weight:800;font-style:italic;font-size:20px;letter-spacing:.5px}
    .score{margin-top:6px;font-size:16px}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);flex-direction:column;z-index:120}
    .btn{margin-top:14px;padding:10px 16px;border-radius:8px;border:0;background:#1f8f3d;color:white;font-weight:700;cursor:pointer}
    .turbo{position:absolute;font-size:36px;z-index:28;pointer-events:none;filter:drop-shadow(0 8px 18px rgba(0,0,0,.5))}
    .fly{position:absolute;font-size:28px;z-index:28;pointer-events:none}
    .rocket{position:absolute;font-size:18px;z-index:26}
    .missPopup{position:absolute;left:50%;transform:translateX(-50%);top:28px;background:rgba(255,80,80,0.9);padding:8px 12px;border-radius:8px;font-weight:800;z-index:200;opacity:0;transition:opacity .3s}
    .immunityBarWrap{position:absolute;left:190px;top:18px;width:140px;height:10px;border-radius:8px;background:rgba(255,255,255,0.12);overflow:hidden;z-index:60;display:none}
    .immunityBar{height:100%;width:100%;background:linear-gradient(90deg,#8be3ff,#4be29f);transform-origin:left;transition:width .1s}
    .explosion{position:absolute;width:100px;height:100px;border-radius:50%;pointer-events:none;z-index:40;mix-blend-mode:screen}
    .final-row{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
  <div class="game-wrap" id="game">
    <div class="bg" id="bg"></div>
    <div class="player" id="player">üç∏</div>

    <div class="hud">
      <div class="title"><strong><em>SLIDE</em></strong></div>
      <div class="score">Score: <span id="score">0</span></div>
      <div class="lives">Lives: <span id="lives">0</span></div>
    </div>

    <div id="rings"></div>
    <div id="fruits"></div>
    <div id="turboWrap"></div>
    <div id="flyWrap"></div>
    <div id="rocketWrap"></div>
    <div id="missPopup" class="missPopup"></div>
    <div class="immunityBarWrap" id="immunityWrap"><div class="immunityBar" id="immunityBar"></div></div>

    <div id="overlay" class="overlay" style="display:none">
      <div id="overlayText" style="font-size:28px;font-weight:800"></div>
      <div id="finalDetails" style="margin-top:12px"></div>
      <div id="continueLeaveWrap" style="margin-top:12px; display:flex; gap:12px;">
        <button id="continueBtn" class="btn">CONTINUE (-1 LIFE)</button>
        <button id="leaveBtn" class="btn">LEAVE</button>
      </div>
    </div>

    <audio id="jumpSfx" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
    <audio id="shatterSfx" src="https://actions.google.com/sounds/v1/impacts/glass_breaking.ogg" preload="auto"></audio>
    <audio id="winSfx" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
    <audio id="explosionSfx" src="https://actions.google.com/sounds/v1/impacts/explosion.ogg" preload="auto"></audio>
    <audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2023/02/28/audio_91b56b86db.mp3?filename=chill-ambient-14013.mp3" loop preload="auto"></audio>
  </div>

<script>
(async function(){
  // ---------------------- CONFIG ----------------------
  const PLAYER_X = 120;
  const GAME_HEIGHT = 500;
  const GRAVITY = 0.6;
  const JUMP_FORCE = -10;
  const RING_COUNT = 100;
  const RING_SPACING = 300;
  const FRUITS = ["üçé","üçå","üçá","üçä","üçâ","üçì","üçç","ü•ù","üçí","üçê"];
  const FRUIT_POINTS = [5,10,15,20,25,30,35,40,50,100];
  const baseSpeed = 2;
  const turboImmuneSeconds = 7;
  const TURBO_INTERVAL = 14000; // 14s
  const TURBO_DURATION = 3000; // 3s
  const flySpeedMultiplier = 0.5;
  const rocketSpawnInterval = 10000;
  let rocketSpeedMultiplier = 1;

  // ---------------------- STATE ----------------------
  let playerY = 200;
  let velocity = 0;
  let rings = [];
  let fruits = [];
  let score = 0;
  let gameOver = false;
  let bgX = 0;
  let missedRings = 0;
  const MISS_LIMIT = 5;
  let processedRings = 0;
  let turbo = null;
  let fly = null;
  let activeRockets = [];
  let rocketIntervalId = null;
  let immune = false;
  let immuneRemaining = 0;
  let immunityTimerId = null;
  let ringMultiplier = 1;
  let lives = 0; // <- new: store player lives

  // ---------------------- DOM ----------------------
  const gameEl = document.getElementById('game');
  const playerEl = document.getElementById('player');
  const ringsEl = document.getElementById('rings');
  const fruitsEl = document.getElementById('fruits');
  const scoreEl = document.getElementById('score');
  const overlay = document.getElementById('overlay');
  const overlayText = document.getElementById('overlayText');
  const finalDetails = document.getElementById('finalDetails');
  const restartBtn = document.getElementById('restart');
  const bgEl = document.getElementById('bg');
  const jumpSfx = document.getElementById('jumpSfx');
  const shatterSfx = document.getElementById('shatterSfx');
  const explosionSfx = document.getElementById('explosionSfx');
  const bgMusic = document.getElementById('bgMusic');
  const turboWrap = document.getElementById('turboWrap');
  const flyWrap = document.getElementById('flyWrap');
  const rocketWrap = document.getElementById('rocketWrap');
  const missPopup = document.getElementById('missPopup');
  const immunityWrap = document.getElementById('immunityWrap');
  const immunityBar = document.getElementById('immunityBar');
  const livesEl = document.getElementById('lives');
  const continueBtn = document.getElementById('continueBtn');
  const leaveBtn = document.getElementById('leaveBtn');

  // ---------------------- INIT ----------------------
  async function loadLives(){
    try {
      // assume firebase auth initialized
      const uid = firebase.auth().currentUser.uid;
      const resp = await fetch(`https://payfast-backend-475447495901.europe-west1.run.app/game/start`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid})
      });
      const data = await resp.json();
      lives = data.lives || 0;
      livesEl.textContent = lives;
      if(lives<=0) overlay.style.display='flex', overlayText.textContent='No Lives Available', continueBtn.style.display='none';
    } catch(err){
      console.error('Lives load error',err);
    }
  }

  await loadLives();

  // ---------------------- PATCH 1 END ----------------------
})();
</script>
<script>
(async function(){
  // ----------------------- SPAWN RINGS & FRUITS -----------------------
  function spawnRings(){
    rings = [];
    ringsEl.innerHTML = '';
    for(let i=0;i<RING_COUNT;i++){
      const x = 800 + i * 300;
      const y = 80 + Math.random()*(GAME_HEIGHT-160);
      const ring = {x,y,passed:false,processed:false,el:null};
      rings.push(ring);
      const el = document.createElement('div');
      el.className='ring visual';
      el.style.left=x+'px'; el.style.top=y+'px';
      ringsEl.appendChild(el); ring.el=el;
    }
  }

  function spawnFruits(){
    fruits=[]; fruitsEl.innerHTML='';
    for(let i=0;i<FRUITS.length;i++){
      const x=600+Math.random()*2000;
      const y=50+Math.random()*(GAME_HEIGHT-100);
      const fruit={x,y,emoji:FRUITS[i],points:FRUIT_POINTS[i],collected:false,el:null};
      fruits.push(fruit);
      const el=document.createElement('div');
      el.className='fruit'; el.textContent=fruit.emoji;
      el.style.left=x+'px'; el.style.top=y+'px';
      fruitsEl.appendChild(el); fruit.el=el;
    }
  }

  // ----------------------- TURBO -----------------------
  function spawnTurbo(){
    if(gameOver || turbo) return;
    const startX=900, startY=60+Math.random()*(GAME_HEIGHT-120);
    const el=document.createElement('div');
    el.className='turbo'; el.textContent='üå©';
    el.style.left=startX+'px'; el.style.top=startY+'px';
    turboWrap.appendChild(el);
    turbo={el,startX,startY,startTime:performance.now()};
  }

  function updateTurbo(){
    if(!turbo) return;
    const elapsed = performance.now()-turbo.startTime;
    const t = elapsed/TURBO_DURATION;
    if(t>=1){ turbo.el.remove(); turbo=null; return; }
    const x=turbo.startX-980*t;
    const zigzag=Math.sin(t*Math.PI*6)*80;
    const y=turbo.startY+zigzag;
    turbo.el.style.left=x+'px'; turbo.el.style.top=y+'px';
    const dx=(PLAYER_X+24)-(x+18), dy=(playerY+36)-(y+18);
    if(Math.sqrt(dx*dx+dy*dy)<36){ consumeTurbo(); turbo.el.remove(); turbo=null; }
  }

  function consumeTurbo(){
    missedRings=Math.max(0,missedRings-1);
    showMissPopup('-1 MISSED RINGS');
    immune=true; immuneRemaining=turboImmuneSeconds;
    immunityWrap.style.display='block';
    updateImmunityBar();
    if(immunityTimerId) clearInterval(immunityTimerId);
    immunityTimerId=setInterval(()=>{
      immuneRemaining-=0.1;
      if(immuneRemaining<=0){
        clearInterval(immunityTimerId); immunityTimerId=null;
        immune=false; immunityWrap.style.display='none'; immunityBar.style.width='100%';
        playerEl.style.transform='';
      } else updateImmunityBar();
    },100);
  }

  function updateImmunityBar(){
    const pct=Math.max(0,Math.min(1,immuneRemaining/turboImmuneSeconds));
    immunityBar.style.width=(pct*100)+'%';
  }

  setInterval(spawnTurbo,TURBO_INTERVAL);

  // ----------------------- FLY -----------------------
  function spawnFly(){
    if(gameOver || fly) return;
    const x=900, y=80+Math.random()*(GAME_HEIGHT-160);
    const el=document.createElement('div'); el.className='fly'; el.textContent='ü™∞';
    el.style.left=x+'px'; el.style.top=y+'px'; flyWrap.appendChild(el);
    fly={el,x,y,phase:0,phaseStart:performance.now()};
  }

  function updateFly(){
    if(!fly) return;
    const now=performance.now(); const elapsed=now-fly.phaseStart;
    if(fly.phase===0){ fly.x-=3*(immune?3:1); fly.y+=Math.sin(elapsed/120)*2;
      if(elapsed>=3000){ fly.phase=1; fly.phaseStart=now; } }
    else if(fly.phase===1){ fly.x+=6; if(fly.x>900){ fly.phase=2; fly.phaseStart=now; } }
    else if(fly.phase===2){ fly.x-=4*(immune?3:1); fly.y+=Math.sin(elapsed/100)*3; if(elapsed>=4000){ fly.el.remove(); fly=null; return; } }
    fly.el.style.left=fly.x+'px'; fly.el.style.top=fly.y+'px';
    const dx=(PLAYER_X+24)-(fly.x+12), dy=(playerY+36)-(fly.y+12);
    if(Math.sqrt(dx*dx+dy*dy)<30){ if(!immune) endGame('üí• Caught by a Fly! üí•'); else { fly.el.remove(); fly=null; } }
  }

  // ----------------------- ROCKETS -----------------------
  function spawnRocketAt(x,y,speed){
    const rocketEl=document.createElement('div'); rocketEl.className='rocket'; rocketEl.textContent='üöÄ';
    rocketEl.style.left=x+'px'; rocketEl.style.top=y+'px';
    rocketWrap.appendChild(rocketEl);
    activeRockets.push({el:rocketEl,x,y,vx:-speed,vy:0});
  }

  function spawnRocket(){
    if(gameOver) return;
    const x=900, y=40+Math.random()*(GAME_HEIGHT-80);
    const baseSpeed=6+Math.random()*3;
    const speed=baseSpeed*rocketSpeedMultiplier;
    spawnRocketAt(x,y,speed);
  }

  function updateRockets(){
    for(let i=activeRockets.length-1;i>=0;i--){
      const r=activeRockets[i];
      const targetY=playerY+36;
      r.vy+=(targetY-r.y)*0.04; if(r.vy>8) r.vy=8; if(r.vy<-8) r.vy=-8;
      r.x+=r.vx; r.y+=r.vy;
      r.el.style.left=r.x+'px'; r.el.style.top=r.y+'px';
      const dx=(PLAYER_X+24)-(r.x+12), dy=(playerY+36)-(r.y+12);
      if(Math.sqrt(dx*dx+dy*dy)<36){ r.el.remove(); activeRockets.splice(i,1);
        if(!immune){ explosionAt(r.x,r.y); endGame('üî• Hit by a Rocket! üî•'); return; } }
      if(r.x<-120||r.y<-120||r.y>GAME_HEIGHT+120){ r.el.remove(); activeRockets.splice(i,1); }
    }
  }

  // ----------------------- MISC -----------------------
  let missPopupTimeout=null;
  function showMissPopup(text){ missPopup.textContent=text; missPopup.style.opacity=1; if(missPopupTimeout) clearTimeout(missPopupTimeout); missPopupTimeout=setTimeout(()=>{missPopup.style.opacity=0;},1200); }
  function explosionAt(x,y){ const el=document.createElement('div'); el.className='explosion'; el.style.left=(x-40)+'px'; el.style.top=(y-40)+'px';
    el.style.background='radial-gradient(circle at 30% 30%, rgba(255,200,60,0.9), rgba(255,40,0,0.8) 40%, rgba(0,0,0,0) 70%)'; gameEl.appendChild(el); explosionSfx.currentTime=0; explosionSfx.play().catch(()=>{}); setTimeout(()=>el.remove(),800); }

  // ----------------------- SCORING & RING PROCESS -----------------------
  function checkRocketSpeed(){ 
    if(processedRings>=70) ringMultiplier=30;
    else if(processedRings>=35) ringMultiplier=15;
    else if(processedRings>=15) ringMultiplier=5;
    if(processedRings>=20 && processedRings<40) rocketSpeedMultiplier=1.5;
    if(processedRings>=40) rocketSpeedMultiplier=1.8;
  }

  function checkAllRingsProcessed(){ if(processedRings>=RING_COUNT) finalizeScore(); }

  function finalizeScore(){
    if(gameOver) return;
    gameOver=true; bgMusic.pause();
    const finalScore = score*100;
    const playTimeSeconds = Math.floor(performance.now()/1000);

    if(window.firebase && firebase.auth().currentUser){
      fetch("https://payfast-backend-475447495901.europe-west1.run.app/scores/submit-score",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({uid:firebase.auth().currentUser.uid, score:finalScore, duration:playTimeSeconds})
      }).then(r=>r.json()).then(d=>console.log("Score saved:",d)).catch(err=>console.error("Score error:",err));
    }

    overlayText.textContent='üèÅ FINISHED';
    finalDetails.innerHTML=`<div class="final-row"><div style="font-size:20px;font-weight:800">Final Score:</div>
      <div style="font-size:20px;margin-left:8px">${finalScore.toLocaleString()}</div></div>`;
    overlay.style.display='flex';
    // Continue button logic
    continueBtn.style.display = lives>0 ? 'inline-block':'none';
  }

  function endGame(text){
    if(gameOver) return;
    gameOver=true; shatterSfx.currentTime=0; shatterSfx.play().catch(()=>{}); bgMusic.pause();
    overlayText.textContent=text; finalDetails.innerHTML=''; overlay.style.display='flex';
    continueBtn.style.display = lives>0 ? 'inline-block':'none';
  }

  // ----------------------- JUMP -----------------------
  function jump(){ if(gameOver) return; velocity=JUMP_FORCE; jumpSfx.currentTime=0; jumpSfx.play().catch(()=>{}); }
  gameEl.addEventListener('click',()=>{ if(bgMusic.paused){bgMusic.volume=0.3; bgMusic.play().catch(()=>{});} jump(); });
  window.addEventListener('keydown',e=>{ if(e.code==='Space'){ if(bgMusic.paused) bgMusic.play().catch(()=>{}); jump(); e.preventDefault(); } });

  // ----------------------- CONTINUE / LEAVE -----------------------
  continueBtn.addEventListener('click',async()=>{
    if(lives<=0) return;
    // Deduct life via backend
    try{
      const resp = await fetch(`https://payfast-backend-475447495901.europe-west1.run.app/game/continue`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid:firebase.auth().currentUser.uid})
      });
      const data = await resp.json();
      if(data.success){
        lives = data.livesRemaining; livesEl.textContent=lives;
        overlay.style.display='none';
        gameOver=false;
        playerY=200; velocity=0; missedRings=0; processedRings=0; score=0; scoreEl.textContent=score;
        spawnRings(); spawnFruits(); playerEl.style.top=playerY+'px'; requestAnimationFrame(update);
      } else { alert('No lives left'); continueBtn.style.display='none'; }
    } catch(err){ console.error('Continue error',err); }
  });

  leaveBtn.addEventListener('click',()=>{ overlay.style.display='none'; location.reload(); });

  // ----------------------- PATCH 2 END -----------------------
})();
</script>
<script>
(async function(){
  // ----------------------- MAIN UPDATE LOOP -----------------------
  function update(){
    if(gameOver) return;

    // Apply gravity
    velocity += GRAVITY;
    playerY += velocity;

    // Floor / ceiling collision
    if(playerY > GAME_HEIGHT - 80){
      playerY = GAME_HEIGHT - 80;
      if(!immune){ endGame('üíî Glass Shattered! üíî'); return; }
      else velocity = Math.min(velocity, 2);
    }
    if(playerY < 0) playerY = 0, velocity = Math.max(velocity, 0);

    // Move background
    const mult = immune ? 3 : 1;
    bgX -= baseSpeed * mult;
    bgEl.style.backgroundPosition = bgX + 'px 0px';

    // Immunity visual
    if(immune){
      const nudge = Math.min(12, (mult-1)*6);
      const bob = Math.sin(performance.now()/150)*2;
      playerEl.style.transform = `translateX(${nudge}px) translateY(${bob}px) scale(1.02)`;
    } else playerEl.style.transform='';

    // ----------------------- RINGS COLLISION -----------------------
    for(let r of rings){
      r.x -= baseSpeed * mult;
      if(r.el) r.el.style.left = r.x+'px';

      if(!r.processed){
        const dx=(PLAYER_X+24)-(r.x+42), dy=(playerY+36)-(r.y+42);
        const distance=Math.sqrt(dx*dx + dy*dy);

        // Ring collected
        if(!r.passed && Math.abs(r.x-PLAYER_X)<60 && distance<36){
          r.passed=true; r.processed=true;
          if(r.el) r.el.style.opacity=0.25;
          score += ringMultiplier; processedRings++; scoreEl.textContent=score;
          checkRocketSpeed(); checkAllRingsProcessed();
        }

        // Ring missed
        if(!r.processed && (r.x+84)<60){
          r.processed=true; processedRings++;
          if(!immune){
            missedRings++;
            showMissPopup(missedRings+' MISSED');
            if(missedRings>=MISS_LIMIT){ endGame('GAME OVER ‚Äî Too Many Misses'); return; }
          } else { showMissPopup('IMMUNE ‚Äî MISS IGNORED'); }
          checkAllRingsProcessed();
        }
      }
    }

    // ----------------------- FRUITS COLLISION -----------------------
    for(let f of fruits){
      if(f.collected) continue;
      f.x -= baseSpeed * mult;

      // Attract to player if immune
      if(immune){
        const pull=0.06;
        f.x += (PLAYER_X - f.x) * pull;
        f.y += (playerY - f.y) * pull;
        if(f.el){ f.el.style.left=f.x+'px'; f.el.style.top=f.y+'px'; }
      } else if(f.el) f.el.style.left=f.x+'px';

      const dx=(PLAYER_X+24)-(f.x+16), dy=(playerY+36)-(f.y+16);
      if(Math.sqrt(dx*dx+dy*dy)<40){
        f.collected=true; if(f.el) f.el.style.display='none';
        score += f.points; scoreEl.textContent=score;
      }
    }

    // ----------------------- UPDATE POWERUPS & ROCKETS -----------------------
    updateTurbo();
    updateFly();
    updateRockets();
    if(!fly && Math.random()<0.002) spawnFly();

    // Update player element
    playerEl.style.top = playerY+'px';

    requestAnimationFrame(update);
  }

  // ----------------------- START GAME -----------------------
  spawnRings();
  spawnFruits();
  playerEl.style.top = playerY+'px';
  requestAnimationFrame(update);

  rocketIntervalId = setInterval(()=>{
    spawnRocket();
  }, rocketSpawnInterval);

  window.addEventListener('beforeunload', ()=>{ clearInterval(rocketIntervalId); });

})();
</script>
